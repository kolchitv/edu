<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ†Ø² - Ø¨Ø±ÙˆÙÙŠØ³ÙˆØ± Ø³Ø¹ÙŠØ¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff;
            --primary: #4a69bd;
            --accent: #6c5ce7;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
            --text-dark: #2d3436;
            --text-light: #636e72;
            --girl: #fd79a8;
            --boy: #0984e3;
            --gold: #ffeaa7;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
        }

        .main-container {
            max-width: 1400px; margin: 0 auto; background: rgba(255, 255, 255, 0.95);
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 25px; min-height: 90vh;
        }

        /* --- Header & Inputs --- */
        .header {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f1f2f6;
        }

        .header h1 { margin: 0; color: var(--accent); font-size: 1.8rem; font-weight: 900; }

        .add-student-area {
            display: flex; gap: 15px; background: #f8f9fa; padding: 15px;
            border-radius: 15px; border: 1px solid #dfe6e9; align-items: center; flex-wrap: wrap;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }

        .input-group { position: relative; display: flex; align-items: center; }
        
        .input-student, .select-gender { 
            padding: 10px 15px; border: 2px solid #dfe6e9; border-radius: 10px;
            font-family: inherit; outline: none; font-weight: 600; transition: 0.3s;
            background: white;
        }
        .input-student:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1); }
        
        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø®Ø§Ù†Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® */
        .date-input-wrapper {
            display: flex; align-items: center; gap: 5px; background: white;
            border: 2px solid #dfe6e9; border-radius: 10px; padding: 0 10px;
        }
        .date-input-wrapper input { border: none; padding: 10px 5px; outline: none; color: var(--text-dark); font-family: 'Cairo'; font-weight: bold; }
        .date-label { font-size: 0.9rem; color: #b2bec3; white-space: nowrap; }

        .btn-add { 
            background: var(--accent); color: white; border: none; padding: 10px 25px; 
            border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(108, 92, 231, 0.3);
        }
        .btn-add:hover { transform: translateY(-2px); }
        .btn-add.editing { background: var(--warning); color: #333; }
        
        .control-panel { display: flex; gap: 10px; }
        .btn-action { 
            padding: 10px 20px; border: none; border-radius: 12px; cursor: pointer; color: white; 
            font-family: inherit; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-reset { background: var(--danger); }
        .btn-save { background: var(--success); }
        .ranking-btn { background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; }

        /* --- Tabs --- */
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; background: #f1f2f6; padding: 5px; border-radius: 15px; width: fit-content; }
        .tab-btn {
            padding: 10px 25px; border: none; background: transparent; border-radius: 12px;
            cursor: pointer; font-weight: 700; color: var(--text-light); transition: 0.3s;
        }
        .tab-btn.active { background: white; color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* --- Student Cards --- */
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .student-card {
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); border: 2px solid transparent;
            transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .student-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .student-card.girl { border-top: 6px solid var(--girl); }
        .student-card.boy { border-top: 6px solid var(--boy); }
        
        /* Absent State */
        .student-card.absent { 
            opacity: 0.6; background: #f1f2f6; filter: grayscale(90%); 
            border-top-color: #b2bec3 !important; transform: scale(0.98);
        }
        .student-card.absent .skills-container { pointer-events: none; opacity: 0.4; }

        /* Header inside card */
        .student-header { 
            display: flex; justify-content: space-between; align-items: flex-start; 
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #dfe6e9; 
        }
        .student-info { display: flex; flex-direction: column; }
        .student-name { font-size: 1.3rem; font-weight: 800; color: var(--text-dark); display: flex; align-items: center; gap: 5px; }
        
        /* Attendance Toggle Switch */
        .attendance-switch {
            position: relative; display: inline-block; width: 50px; height: 26px; margin-top: 5px;
        }
        .attendance-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(24px); }
        .attendance-label { font-size: 0.8rem; font-weight: bold; margin-right: 5px; display: block; margin-top: 5px; }
        .absent-text { color: var(--text-light); } .present-text { color: var(--success); }

        .total-badge {
            background: var(--primary); color: white; padding: 5px 15px;
            border-radius: 50px; font-weight: 900; font-size: 1.4rem; 
            min-width: 60px; text-align: center; box-shadow: 0 4px 10px rgba(74, 105, 189, 0.3);
        }
        .total-badge.negative { background: var(--danger); box-shadow: 0 4px 10px rgba(214, 48, 49, 0.3); }

        /* Skills */
        .skills-container { display: flex; flex-direction: column; gap: 8px; }
        .skill-row { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #f8f9fa; border-radius: 12px; padding: 8px 10px; transition: 0.2s;
        }
        .skill-row:hover { background: #f1f2f6; }
        .skill-row.behavior { background: #fff5f5; border: 1px solid #ffecec; }
        
        .btn-control { 
            width: 30px; height: 30px; border-radius: 50%; border: none; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: 0.2s;
        }
        .btn-minus { background: #dfe6e9; color: #636e72; }
        .btn-plus { background: var(--success); color: white; }
        .btn-plus.behavior-btn { background: var(--danger); }

        /* Card Actions */
        .card-actions { position: absolute; top: 15px; left: 15px; display: flex; gap: 5px; }
        .action-icon { 
            width: 30px; height: 30px; border-radius: 8px; border: none; cursor: pointer; 
            background: #f1f2f6; color: #636e72; transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .action-icon:hover { background: var(--accent); color: white; }

        /* Podium */
        .podium-container {
            display: flex; justify-content: center; align-items: flex-end; gap: 20px;
            margin: 20px auto 40px; padding: 30px; background: white; border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); min-height: 220px; max-width: 800px;
        }
        .podium-place { text-align: center; display: flex; flex-direction: column; align-items: center; flex: 1; }
        .podium-avatar { font-size: 3rem; margin-bottom: 10px; }
        .podium-bar { width: 80%; border-radius: 15px 15px 0 0; color: #333; font-weight: 900; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 15px; }
        .rank-1 .podium-bar { height: 140px; background: linear-gradient(180deg, #ffeaa7 0%, #fdcb6e 100%); }
        .rank-2 .podium-bar { height: 100px; background: linear-gradient(180deg, #dfe6e9 0%, #b2bec3 100%); }
        .rank-3 .podium-bar { height: 80px; background: linear-gradient(180deg, #fab1a0 0%, #e17055 100%); }

        /* Tables & Charts styling remains similar */
        .records-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .records-table th { padding: 15px; text-align: center; color: var(--text-light); border-bottom: 2px solid #dfe6e9; }
        .records-table td { background: white; padding: 15px; text-align: center; border-top: 1px solid #f1f2f6; border-bottom: 1px solid #f1f2f6; }
        
        .cake-icon { font-size: 1.5rem; animation: bounce 1s infinite alternate; display: inline-block; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }

        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .add-student-area { flex-direction: column; width: 100%; }
            .input-student { width: 100%; }
            .podium-container { display: none; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- Ø§Ù„Ø±Ø£Ø³ -->
        <div class="header">
            <div>
                <h1><span>ğŸ’</span> Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ†Ø² <span style="font-size: 1rem; color: #b2bec3; margin-right: 10px;">Prof Said</span></h1>
            </div>
            
            <div class="add-student-area">
                <input type="hidden" id="editIndex" value="-1">
                
                <div class="input-group">
                    <input type="text" id="studentName" class="input-student" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯...">
                </div>
                
                <select id="studentGender" class="select-gender">
                    <option value="boy">Ø°ÙƒØ± ğŸ‘¦</option>
                    <option value="girl">Ø£Ù†Ø«Ù‰ ğŸ‘§</option>
                </select>
                
                <!-- ØªØ­Ø³ÙŠÙ† Ø®Ø§Ù†Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® -->
                <div class="date-input-wrapper">
                    <span class="date-label">ğŸ“… Ø§Ù„Ø§Ø²Ø¯ÙŠØ§Ø¯:</span>
                    <input type="date" id="studentBirth">
                </div>

                <button id="addBtn" class="btn-add" onclick="handleStudentSubmit()">+ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
                <button id="cancelEditBtn" class="btn-add" onclick="cancelEdit()" style="display: none; background: #95a5a6;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>

            <div class="control-panel">
                <button class="ranking-btn" onclick="switchTab('ranking')">ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨</button>
                <button class="btn-action btn-reset" onclick="resetAll()">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„</button>
                <button class="btn-action btn-save" onclick="saveDay()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ…</button>
            </div>
        </div>

        <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            <button class="tab-btn" onclick="switchTab('profile')">ğŸ“„ Ù…Ù„Ù Ø§Ù„ØªÙ„Ù…ÙŠØ°</button>
            <button class="tab-btn" onclick="switchTab('analytics')">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</button>
            <button class="tab-btn" onclick="switchTab('records')">ğŸ“… Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
        </div>

        <!-- 1. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
        <div id="dashboard" class="content-section">
            <div id="podiumDisplay" class="podium-container" style="display: none;"></div>
            <div class="student-grid" id="studentsContainer"></div>
            <div id="emptyState" style="text-align: center; color: #999; display: none; padding: 40px;">
                <h3>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©! ğŸ’</h3>
                <p>Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø¨Ø¯Ø¡.</p>
            </div>
        </div>

        <!-- 2. Ø§Ù„ØªØ±ØªÙŠØ¨ -->
        <div id="ranking" class="content-section" style="display: none;">
            <div style="background: white; padding: 30px; border-radius: 20px;">
                <h2 style="text-align: center; margin-bottom: 20px;">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h2>
                <table class="records-table">
                    <thead><tr><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                    <tbody id="rankingTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 3. Ù…Ù„Ù Ø§Ù„ØªÙ„Ù…ÙŠØ° -->
        <div id="profile" class="content-section" style="display: none;">
            <div style="text-align: center; margin-bottom: 20px;">
                <select id="profileStudentSelector" onchange="loadStudentProfile()" style="padding: 10px; font-size: 1rem; border-radius: 10px;"></select>
            </div>
            <div id="reportCard" style="background: white; padding: 40px; border-radius: 20px; max-width: 800px; margin: 0 auto; border: 1px solid #f1f2f6;">
                <div style="text-align: center; border-bottom: 2px dashed #f1f2f6; padding-bottom: 20px; margin-bottom: 20px;">
                    <h2 id="pName" style="color: var(--primary); margin:0;">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                    <div id="pDetails" style="color: var(--text-light);"></div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <div class="stat-value" id="pTotal" style="font-size: 1.8rem; font-weight: 900; color: var(--accent);">0</div>
                        <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ</div>
                    </div>
                    <div style="background: #fff5f5; padding: 15px; border-radius: 10px;">
                        <div class="stat-value" id="pAbsences" style="font-size: 1.8rem; font-weight: 900; color: var(--danger);">0</div>
                        <div>Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</div>
                    </div>
                    <div style="background: #e6fffa; padding: 15px; border-radius: 10px;">
                        <div class="stat-value" id="pTopSkill" style="font-size: 1.2rem; font-weight: 900; color: var(--success);">-</div>
                        <div>Ù†Ù‚Ø·Ø© Ø§Ù„Ù‚ÙˆØ©</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="height: 250px;"><canvas id="profileLineChart"></canvas></div>
                    <div style="height: 250px;"><canvas id="profileRadarChart"></canvas></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-action btn-save" style="margin: 0 auto;" onclick="downloadPDF()">ğŸ“„ ØªØ­Ù…ÙŠÙ„ PDF</button>
            </div>
        </div>

        <!-- 4. Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª -->
        <div id="analytics" class="content-section" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: white; padding: 15px; border-radius: 20px;"><canvas id="lineChart"></canvas></div>
                <div style="background: white; padding: 15px; border-radius: 20px;"><canvas id="genderBarChart"></canvas></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div style="background: white; padding: 15px; border-radius: 20px;"><canvas id="genderPieChart"></canvas></div>
                <div style="background: white; padding: 15px; border-radius: 20px;">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <select id="studentSelector" onchange="updateBarChart()" style="padding: 5px;"></select>
                    </div>
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 5. Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
        <div id="records" class="content-section" style="display: none;">
            <div style="background: white; padding: 20px; border-radius: 20px;">
                <h2 style="text-align: center;">ğŸ“… Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹</h2>
                <div style="overflow-x: auto;">
                    <table class="records-table">
                        <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</th></tr></thead>
                        <tbody id="recordsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const skills = [
            { id: 'rituels', name: 'Rituels (Ø§Ø¹ØªÙŠØ§Ø¯ÙŠØ©)', icon: 'â˜€ï¸' },
            { id: 'interaction', name: 'Interaction (ØªÙˆØ§ØµÙ„)', icon: 'ğŸ—£ï¸' },
            { id: 'ecoute', name: 'ComprÃ©hension (ÙÙ‡Ù…)', icon: 'ğŸ‘‚' },
            { id: 'lecture', name: 'Lecture (Ù‚Ø±Ø§Ø¡Ø©)', icon: 'ğŸ“–' },
            { id: 'ecriture', name: 'Ã‰criture (ÙƒØªØ§Ø¨Ø©)', icon: 'âœï¸' },
            { id: 'comportement', name: 'Comportement (Ø³Ù„ÙˆÙƒ)', icon: 'âš ï¸', isNegative: true }
        ];

        let students = JSON.parse(localStorage.getItem('profSaidStudents_v8')) || [];

        function initData() {
            students.forEach(s => {
                if (!s.scores) s.scores = {};
                // s.dailyTotal: Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
                if (typeof s.dailyTotal === 'undefined') s.dailyTotal = 0;
                // s.historicalTotal: Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²Ù† Ù…Ù† Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                if (typeof s.historicalTotal === 'undefined') s.historicalTotal = s.total || 0; // ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                
                if (!s.history) s.history = [0];
                if (!s.historyLog) s.historyLog = [];
                if (!s.gender) s.gender = 'boy';
                if (!s.absences) s.absences = 0;
                if (typeof s.isAbsent === 'undefined') s.isAbsent = false;
                
                skills.forEach(skill => {
                    if (typeof s.scores[skill.id] === 'undefined') s.scores[skill.id] = 0;
                });
            });
            saveData();
        }
        initData();

        function saveData() {
            localStorage.setItem('profSaidStudents_v8', JSON.stringify(students));
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ (Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ + Ø§Ù„ÙŠÙˆÙ…ÙŠ)
        function getGrandTotal(s) {
            return (s.historicalTotal || 0) + (s.dailyTotal || 0);
        }

        function handleStudentSubmit() {
            const index = document.getElementById('editIndex').value;
            const name = document.getElementById('studentName').value.trim();
            const gender = document.getElementById('studentGender').value;
            const birth = document.getElementById('studentBirth').value;

            if (!name) { alert('Ø§Ù„Ù…Ø±Ø¬Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨!'); return; }

            if (index === "-1") {
                const newStudent = {
                    id: Date.now(), name, gender, birthdate: birth,
                    scores: {}, dailyTotal: 0, historicalTotal: 0,
                    history: [], historyLog: [], absences: 0, isAbsent: false
                };
                skills.forEach(skill => newStudent.scores[skill.id] = 0);
                students.push(newStudent);
            } else {
                students[index].name = name;
                students[index].gender = gender;
                students[index].birthdate = birth;
                cancelEdit();
            }
            saveData();
            document.getElementById('studentName').value = '';
            document.getElementById('studentBirth').value = '';
            renderDashboard();
            updateCharts();
            renderRecords();
        }

        function editStudent(index) {
            const s = students[index];
            document.getElementById('studentName').value = s.name;
            document.getElementById('studentGender').value = s.gender;
            document.getElementById('studentBirth').value = s.birthdate || '';
            document.getElementById('editIndex').value = index;
            const btn = document.getElementById('addBtn');
            btn.innerText = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"; btn.classList.add('editing');
            document.getElementById('cancelEditBtn').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentBirth').value = '';
            document.getElementById('editIndex').value = "-1";
            document.getElementById('addBtn').innerText = "+ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨";
            document.getElementById('addBtn').classList.remove('editing');
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function deleteStudent(index) {
            if(confirm(`Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ "${students[index].name}"ØŸ`)) {
                if(document.getElementById('editIndex').value == index) cancelEdit();
                students.splice(index, 1);
                saveData(); renderDashboard();
            }
        }

        // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØºÙŠØ§Ø¨ (Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        function toggleAbsence(index, isChecked) {
            const s = students[index];
            // Ø¥Ø°Ø§ Ø£ØµØ¨Ø­ ØºØ§Ø¦Ø¨Ø§Ù‹ (Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ checked ÙŠØ¹Ù†ÙŠ Ø­Ø§Ø¶Ø±ØŒ unchecked ÙŠØ¹Ù†ÙŠ ØºØ§Ø¦Ø¨
            const isNowAbsent = !isChecked; 
            
            s.isAbsent = isNowAbsent;
            
            if (s.isAbsent) {
                // Ø®ØµÙ… Ù†Ù‚Ø·Ø© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨
                s.dailyTotal -= 1;
                s.absences += 1;
            } else {
                // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© (ØªØµØ­ÙŠØ­)
                s.dailyTotal += 1;
                s.absences = Math.max(0, s.absences - 1);
            }
            saveData();
            renderDashboard();
        }

        function renderDashboard() {
            const container = document.getElementById('studentsContainer');
            const emptyState = document.getElementById('emptyState');
            const podiumDisplay = document.getElementById('podiumDisplay');
            const today = new Date();

            updateDropdowns();

            container.innerHTML = '';
            if (students.length === 0) {
                emptyState.style.display = 'block'; podiumDisplay.style.display = 'none'; return;
            } else {
                emptyState.style.display = 'none';
            }

            // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ (Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ + Ø§Ù„ÙŠÙˆÙ…ÙŠ)
            let sortedStudents = [...students].sort((a, b) => getGrandTotal(b) - getGrandTotal(a));
            const championId = (sortedStudents[0] && getGrandTotal(sortedStudents[0]) > 0) ? sortedStudents[0].id : null;
            
            if (championId) {
                podiumDisplay.style.display = 'flex';
                renderPodium(sortedStudents);
            } else {
                podiumDisplay.style.display = 'none';
            }

            students.forEach((student, index) => {
                const card = document.createElement('div');
                let classes = `student-card ${student.gender}`;
                if (student.isAbsent) classes += ' absent';
                if (student.id === championId && !student.isAbsent) classes += ' champion'; 

                let birthdayIcon = '';
                if(student.birthdate) {
                    const bdate = new Date(student.birthdate);
                    if(bdate.getDate() === today.getDate() && bdate.getMonth() === today.getMonth()) {
                        birthdayIcon = '<span class="cake-icon">ğŸ‚</span>';
                    }
                }
                card.className = classes;

                let skillsHTML = '';
                skills.forEach(skill => {
                    const isBehavior = skill.id === 'comportement';
                    const rowClass = isBehavior ? 'skill-row behavior' : 'skill-row';
                    const plusBtnClass = isBehavior ? 'btn-plus behavior-btn' : 'btn-plus';
                    
                    skillsHTML += `
                        <div class="${rowClass}">
                            <div class="skill-info"><span>${skill.icon}</span><span>${skill.name.split('(')[0]}</span></div>
                            <button class="btn-control btn-minus" onclick="updateScore(${index}, '${skill.id}', -1)" ${student.isAbsent ? 'disabled' : ''}>-</button>
                            <span class="skill-score">${student.scores[skill.id]}</span>
                            <button class="btn-control ${plusBtnClass}" onclick="updateScore(${index}, '${skill.id}', 1)" ${student.isAbsent ? 'disabled' : ''}>+</button>
                        </div>
                    `;
                });

                const genderIcon = student.gender === 'boy' ? 'ğŸ‘¦' : 'ğŸ‘§';
                const currentGrandTotal = getGrandTotal(student);
                const badgeClass = currentGrandTotal < 0 ? 'total-badge negative' : 'total-badge';

                // Ù…ÙØªØ§Ø­ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const isChecked = !student.isAbsent ? 'checked' : '';
                const attendanceLabel = student.isAbsent ? '<span class="attendance-label absent-text">ØºØ§Ø¦Ø¨</span>' : '<span class="attendance-label present-text">Ø­Ø§Ø¶Ø±</span>';

                card.innerHTML = `
                    <div class="card-actions">
                        <button class="action-icon" onclick="editStudent(${index})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                        <button class="action-icon" style="color:#d63031" onclick="deleteStudent(${index})" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                    </div>

                    <div class="student-header">
                        <div class="student-info">
                            <span class="student-name">${genderIcon} ${student.name} ${birthdayIcon}</span>
                            <label class="attendance-switch">
                                <input type="checkbox" ${isChecked} onchange="toggleAbsence(${index}, this.checked)">
                                <span class="slider"></span>
                            </label>
                            ${attendanceLabel}
                        </div>
                        <div style="text-align: center;">
                            <span class="${badgeClass}">${currentGrandTotal}</span>
                            <div style="font-size:0.7rem; color:#b2bec3;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
                        </div>
                    </div>
                    
                    <div class="skills-container">
                        ${student.isAbsent ? '<div style="text-align:center; padding:20px; color:#d63031; font-weight:bold;">Ø§Ù„Ø·Ø§Ù„Ø¨ ØºØ§Ø¦Ø¨ (-1)</div>' : skillsHTML}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderPodium(sorted) {
            const podiumDisplay = document.getElementById('podiumDisplay');
            let html = '';
            const order = [1, 0, 2]; 
            order.forEach(idx => {
                if (sorted[idx] && getGrandTotal(sorted[idx]) > 0) {
                    const s = sorted[idx];
                    const rank = idx + 1;
                    const avatar = s.gender === 'boy' ? 'ğŸ‘¦' : 'ğŸ‘§';
                    const crown = rank === 1 ? '<div class="crown">ğŸ‘‘</div>' : '';
                    html += `
                        <div class="podium-place rank-${rank}">
                            <div class="podium-avatar">${crown}${avatar}</div>
                            <div class="podium-bar">
                                <span class="podium-score">${getGrandTotal(s)}</span>
                            </div>
                            <div class="podium-name">${s.name}</div>
                        </div>
                    `;
                }
            });
            podiumDisplay.innerHTML = html;
        }

        function updateScore(index, skillId, change) {
            if (students[index].isAbsent) return;
            students[index].scores[skillId] += change;
            students[index].dailyTotal += change;
            saveData(); renderDashboard();
        }

        function updateDropdowns() {
            const selectors = [document.getElementById('studentSelector'), document.getElementById('profileStudentSelector')];
            selectors.forEach(sel => {
                const val = sel.value; sel.innerHTML = '';
                students.forEach((s, i) => {
                    let opt = document.createElement('option'); opt.value = i; opt.text = s.name; sel.appendChild(opt);
                });
                if(val && students[val]) sel.value = val;
            });
        }

        function renderRanking() {
            const tbody = document.getElementById('rankingTableBody');
            tbody.innerHTML = '';
            let sorted = [...students].sort((a, b) => getGrandTotal(b) - getGrandTotal(a));
            sorted.forEach((s, i) => {
                const tr = document.createElement('tr');
                const rank = i + 1;
                let rankClass = 'rank-cell';
                let rankIcon = rank;
                if (rank === 1) { rankClass += ' rank-1-cell'; rankIcon = 'ğŸ¥‡ 1'; }
                else if (rank === 2) { rankIcon = 'ğŸ¥ˆ 2'; }
                else if (rank === 3) { rankIcon = 'ğŸ¥‰ 3'; }

                tr.innerHTML = `
                    <td class="${rankClass}">${rankIcon}</td>
                    <td style="font-weight:700;">${s.name}</td>
                    <td>${s.gender === 'boy' ? 'ğŸ‘¦' : 'ğŸ‘§'}</td>
                    <td style="font-weight:900; font-size:1.1rem; color:var(--primary)">${getGrandTotal(s)}</td>
                    <td>${s.isAbsent ? '<span style="color:var(--danger)">ØºØ§Ø¦Ø¨</span>' : '<span style="color:var(--success)">Ø­Ø§Ø¶Ø±</span>'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderRecords() {
            const tbody = document.getElementById('recordsTableBody');
            tbody.innerHTML = '';
            students.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:700;">${s.name}</td>
                    <td>${s.absences}</td>
                    <td style="font-weight:bold;">${getGrandTotal(s)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (event.target.classList.contains('tab-btn')) event.target.classList.add('active');
            
            if(tabId === 'analytics') updateCharts();
            if(tabId === 'profile') loadStudentProfile();
            if(tabId === 'records') renderRecords();
            if(tabId === 'ranking') renderRanking();
        }

        function saveDay() {
            if(confirm("Ù‡Ù„ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø­ØµØ©ØŸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ØŒ ÙˆØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø³ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ Ù…Ø­ÙÙˆØ¸Ø§Ù‹).")) {
                const todayStr = new Date().toISOString().slice(0, 10);
                students.forEach(s => {
                    // 1. Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡ Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ØŒ Ù†Ø³Ø¬Ù„ 0
                    const pointsToday = s.dailyTotal || 0;
                    
                    s.history.push(pointsToday);
                    if (!s.historyLog) s.historyLog = [];
                    s.historyLog.push({ date: todayStr, score: pointsToday });
                    
                    // 2. ØªØ±Ø­ÙŠÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ… Ø¥Ù„Ù‰ "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ"
                    // ØªØ£ÙƒØ¯ Ø£Ù† historicalTotal Ù…Ø¹Ø±Ù
                    if (!s.historicalTotal) s.historicalTotal = 0;
                    s.historicalTotal += pointsToday;

                    // 3. ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙÙ‚Ø·
                    skills.forEach(skill => s.scores[skill.id] = 0);
                    s.dailyTotal = 0; 
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ù„Ø­Ø¶ÙˆØ± ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    s.isAbsent = false;
                });
                saveData(); renderDashboard(); renderRecords(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­ØµØ© Ø¨Ù†Ø¬Ø§Ø­!');
            }
        }
        
        function resetAll() {
            if(confirm('ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø³ÙŠØµÙØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                students.forEach(s => { 
                    s.dailyTotal = 0; s.historicalTotal = 0; s.absences = 0; s.isAbsent = false; s.history = [0];
                    skills.forEach(k => s.scores[k.id] = 0); 
                });
                saveData(); renderDashboard();
            }
        }

        function loadStudentProfile() {
            const index = document.getElementById('profileStudentSelector').value;
            if (index === '') return;
            const s = students[index];
            document.getElementById('pName').innerText = (s.gender === 'boy' ? 'ğŸ‘¦ ' : 'ğŸ‘§ ') + s.name;
            let details = s.gender === 'boy' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰';
            if(s.birthdate) details += ` | Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: ${s.birthdate}`;
            document.getElementById('pDetails').innerText = details;
            
            const total = getGrandTotal(s);
            document.getElementById('pTotal').innerText = total;
            document.getElementById('pAbsences').innerText = s.absences + " Ø£ÙŠØ§Ù…";

            let maxSkill = { val: -999, name: '-' };
            skills.forEach(skill => {
                if(skill.id !== 'comportement' && s.scores[skill.id] > maxSkill.val) {
                    maxSkill = { val: s.scores[skill.id], name: skill.name.split('(')[0] };
                }
            });
            document.getElementById('pTopSkill').innerText = maxSkill.name;
            renderProfileCharts(s);
        }

        function renderProfileCharts(s) {
            const ctxLine = document.getElementById('profileLineChart').getContext('2d');
            const ctxRadar = document.getElementById('profileRadarChart').getContext('2d');
            if(window.pLineChart) window.pLineChart.destroy();
            if(window.pRadarChart) window.pRadarChart.destroy();

            window.pLineChart = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: s.history.map((_, i) => `ÙŠÙˆÙ… ${i+1}`),
                    datasets: [{ label: 'Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠØ©', data: s.history, borderColor: s.gender === 'boy'?'#0984e3':'#fd79a8', tension:0.3, fill:true }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            window.pRadarChart = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: skills.map(k => k.name.split(' ')[1]),
                    datasets: [{ label: 'Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª (Ø§Ù„ÙŠÙˆÙ…)', data: skills.map(k => s.scores[k.id]), borderColor:'#6c5ce7', backgroundColor:'rgba(108, 92, 231, 0.2)' }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function downloadPDF() {
            const element = document.getElementById('reportCard');
            const index = document.getElementById('profileStudentSelector').value;
            const name = students[index].name;
            html2pdf().set({ margin:10, filename:`ØªÙ‚Ø±ÙŠØ±_${name}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }).from(element).save();
        }

        let mainCharts = {};
        function updateCharts() {
            if (students.length === 0) return;
            const ctxLine = document.getElementById('lineChart').getContext('2d');
            const ctxPie = document.getElementById('genderPieChart').getContext('2d');
            const ctxBarG = document.getElementById('genderBarChart').getContext('2d');

            if(mainCharts.line) mainCharts.line.destroy();
            if(mainCharts.pie) mainCharts.pie.destroy();
            if(mainCharts.barG) mainCharts.barG.destroy();

            let maxDays = 0;
            students.forEach(s => { if(s.history.length > maxDays) maxDays = s.history.length; });
            mainCharts.line = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: Array.from({length:maxDays},(_,i)=>`ÙŠÙˆÙ… ${i+1}`),
                    datasets: students.map((s,i)=>({
                        label: s.name, data: s.history, borderColor: s.gender==='boy'?`hsl(200,70%,${50+i*5}%)`:`hsl(340,70%,${50+i*5}%)`, tension:0.1, fill:false
                    }))
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            let boys = students.filter(s => s.gender === 'boy');
            let girls = students.filter(s => s.gender === 'girl');
            let bTotal = boys.reduce((a, b) => a + getGrandTotal(b), 0);
            let gTotal = girls.reduce((a, b) => a + getGrandTotal(b), 0);

            mainCharts.pie = new Chart(ctxPie, {
                type: 'doughnut',
                data: { labels: ['Ø°ÙƒÙˆØ±', 'Ø¥Ù†Ø§Ø«'], datasets: [{ data: [bTotal, gTotal], backgroundColor: ['#0984e3', '#fd79a8'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            mainCharts.barG = new Chart(ctxBarG, {
                type: 'bar',
                data: {
                    labels: ['Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø°ÙƒÙˆØ±', 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†Ø§Ø«'],
                    datasets: [{ label: 'Ø§Ù„Ù…ØªÙˆØ³Ø·', data: [boys.length?(bTotal/boys.length).toFixed(1):0, girls.length?(gTotal/girls.length).toFixed(1):0], backgroundColor: ['#0984e3', '#fd79a8'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
            updateBarChart();
        }

        function updateBarChart() {
            const ctx = document.getElementById('barChart').getContext('2d');
            const idx = document.getElementById('studentSelector').value || 0;
            if(!students[idx]) return;
            const s = students[idx];
            if(mainCharts.bar) mainCharts.bar.destroy();
            mainCharts.bar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: skills.map(k => k.name.split(' ')[1]),
                    datasets: [{ label: s.name, data: skills.map(k => s.scores[k.id]), backgroundColor: skills.map(k => k.id==='comportement'?'#d63031':'#6c5ce7') }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        renderDashboard();
        setTimeout(updateCharts, 500);
    </script>
</body>
</html>