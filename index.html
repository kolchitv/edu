<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me de Jetons - Prof Said (Desktop)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Librairies Externes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root {
            --bg-color: #f0f2f5;
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --text-dark: #2c3e50;
            --girl: #fd79a8;
            --boy: #0984e3;
            --homework-paper: #fffcf0;
            --homework-line: #e3e3e3;
        }

        * { font-family: 'Cairo', sans-serif !important; box-sizing: border-box; }

        body {
            background: var(--bg-color);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
        }

        /* --- Landing Page Styles --- */
        #schoolSelectionPage {
            max-width: 1400px; margin: 0 auto;
            text-align: center; padding: 40px 20px;
        }
        .landing-header h1 { font-size: 3rem; color: var(--primary); margin-bottom: 10px; }
        .landing-header p { font-size: 1.2rem; color: #7f8c8d; margin-bottom: 50px; }
        
        .schools-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;
        }
        
        .school-card {
            background: white; border-radius: 20px; overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid transparent; text-align: left;
            display: flex; flex-direction: column;
            position: relative;
        }
        .school-card:hover {
            transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            border-color: var(--accent);
        }
        .school-card-header {
            padding: 20px; color: white; position: relative;
        }
        .school-card-header h3 { margin: 0; font-size: 1.3rem; line-height: 1.4; font-weight: 800; }
        .school-card-body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; font-size: 0.95rem; color: #555; }
        .school-info-item { display: flex; align-items: flex-start; gap: 10px; }
        .school-badge { 
            background: rgba(255,255,255,0.2); color: white; padding: 5px 10px; 
            border-radius: 15px; font-size: 0.8rem; position: absolute; top: 20px; right: 20px;
            backdrop-filter: blur(5px);
        }
        
        .subgroup-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 15px; }
        .btn-subgroup {
            padding: 8px 5px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: bold;
            cursor: pointer; color: white; transition: 0.2s; text-align: center;
        }
        .btn-subgroup:hover { transform: scale(1.05); }
        .btn-enter-school {
            background: var(--primary); color: white; border: none; width: 100%; padding: 12px;
            border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px;
            transition: 0.2s; font-size: 1rem;
        }
        .btn-enter-school:hover { background: #34495e; }

        /* --- Main App --- */
        #mainApp { display: none; }

        .main-container {
            max-width: 1600px; margin: 0 auto; background: #ffffff;
            border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 30px; min-height: 90vh;
        }

        .header {
            display: flex; justify-content: space-between; align-items: flex-start;
            gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #f1f2f6;
        }
        .header h1 { margin: 0; color: var(--primary); font-size: 1.8rem; font-weight: 900; }
        .back-home-btn { background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Map */
        .map-container {
            width: 100%; height: 250px; background: #eee; border-radius: 15px; overflow: hidden;
            margin-bottom: 25px; border: 1px solid #ddd; position: relative;
        }
        .map-frame { width: 100%; height: 100%; border: 0; }
        
        /* Add Student Area */
        .add-student-area {
            display: flex; gap: 10px; background: #f8f9fa; padding: 15px;
            border: 1px solid #dfe6e9; border-radius: 12px; align-items: flex-end;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); margin-bottom: 20px;
        }
        .input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .input-label { font-size: 0.8rem; color: #7f8c8d; font-weight: bold; }
        .input-student, .select-gender, .select-school, .input-date { 
            padding: 10px; border: 1px solid #bdc3c7; border-radius: 8px; font-weight: 600; width: 100%;
        }
        .btn-add { 
            background: var(--accent); color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; height: 42px; min-width: 100px;
            transition: 0.2s;
        }
        .btn-add:hover { background: #2980b9; transform: translateY(-2px); }

        /* Controls */
        .control-row {
            display: flex; justify-content: space-between; align-items: center; 
            background: #fff; padding: 15px; border-radius: 15px; border: 1px solid #e1e1e1; margin-bottom: 25px;
        }
        .subgroup-select {
            padding: 10px 15px; border: 2px solid var(--accent); border-radius: 8px;
            font-weight: bold; font-size: 1rem; color: var(--accent); min-width: 250px;
            background-color: #f0f8ff; cursor: pointer;
        }
        .control-buttons { display: flex; gap: 15px; }
        .btn-action { 
            padding: 10px 25px; border: none; border-radius: 8px; cursor: pointer; color: white; 
            font-weight: bold; font-size: 1rem; transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .btn-save { background: var(--success); }
        .btn-reset { background: var(--danger); }

        /* --- Tabs --- */
        .tabs { display: flex; gap: 15px; margin-bottom: 25px; padding: 5px; border-bottom: 2px solid #f1f2f6; overflow-x: auto;}
        .tab-btn {
            padding: 12px 30px; border: none; background: transparent; border-radius: 10px 10px 0 0;
            cursor: pointer; font-weight: 700; color: var(--text-light); transition: 0.2s; font-size: 1.1rem;
            border-bottom: 3px solid transparent; white-space: nowrap;
        }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: #f8f9fa; }

        /* --- HOMEWORK PAGE STYLES (NEW) --- */
        .homework-notebook {
            background-color: var(--homework-paper);
            background-image: linear-gradient(var(--homework-line) 1px, transparent 1px);
            background-size: 100% 2.5rem; /* Line height */
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            min-height: 500px;
            position: relative;
        }
        .homework-notebook::before {
            content: ''; position: absolute; left: 30px; top: 0; bottom: 0;
            width: 2px; background: #ffaaaa; /* Red margin line */
        }
        #homeworkTextarea {
            width: 100%; height: 100%; min-height: 450px;
            background: transparent; border: none; outline: none;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.3rem; line-height: 2.5rem;
            color: #2c3e50; resize: none;
            padding-left: 20px;
        }
        .homework-info {
            text-align: center; color: #7f8c8d; margin-top: 10px; font-style: italic;
        }

        /* --- Profile Split Layout --- */
        .profile-layout { display: flex; gap: 30px; align-items: flex-start; }
        .profile-sidebar {
            flex: 1; min-width: 300px; position: sticky; top: 20px;
            background: #f8f9fa; padding: 20px; border-radius: 15px; border: 1px solid #eee;
            display: flex; flex-direction: column; gap: 20px;
        }
        .profile-preview {
            flex: 2; display: flex; justify-content: center;
            background: #555; padding: 20px; border-radius: 15px; overflow-x: auto;
        }
        
        .school-filter-select {
            padding: 10px 15px; border: 2px solid var(--primary); border-radius: 8px;
            font-weight: bold; font-size: 1rem; color: var(--primary); width: 100%;
        }

        /* Report Card */
        #reportCard { 
            background: white !important; padding: 40px; width: 210mm; min-height: 297mm; 
            margin: 0; box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            color: black !important; position: relative; transform-origin: top center;
        }
        .report-header { display: flex; justify-content: space-between; border-bottom: 3px solid #2c3e50; padding-bottom: 20px; margin-bottom: 30px; }
        .daily-report-table { width: 100%; border-collapse: collapse; margin-top: 25px; border: 2px solid #2c3e50; }
        .daily-report-table th, .daily-report-table td { border: 1px solid #7f8c8d; padding: 8px; text-align: center; font-size: 0.9rem; }
        .daily-report-table th { background: #ecf0f1; font-weight: 800; border-bottom: 2px solid #2c3e50; }

        .report-homework-box {
            margin-top: 20px; padding: 15px; border: 2px dashed #f39c12; background: #fffdf5;
            border-radius: 10px;
        }
        .report-homework-box h4 { margin: 0 0 5px 0; color: #d35400; text-transform: uppercase; font-size: 0.9rem; }
        .report-homework-text { font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 1rem; color: #333; }
        
        /* Grid & Components */
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .student-card { background: white; border: 1px solid #eee; border-radius: 16px; padding: 20px; transition: all 0.3s ease; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .student-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: var(--accent); }
        .student-card.girl { border-top: 5px solid var(--girl); }
        .student-card.boy { border-top: 5px solid var(--boy); }
        .student-card.absent { opacity: 0.6; filter: grayscale(100%); background: #f9f9f9; }
        .student-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .student-name { font-size: 1.3rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .total-badge { background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-weight: 900; font-size: 1.5rem; min-width: 60px; text-align: center; }
        .skill-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; background: #fff; padding: 5px; border-radius: 5px; border: 1px solid #f0f0f0; }
        .btn-control { width: 30px; height: 30px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition:0.2s; }
        .btn-minus { background: #ecf0f1; color: #7f8c8d; }
        .btn-plus { background: var(--success); color: white; }
        .behavior-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .behavior-btn { border: 1px solid #eee; border-radius: 8px; cursor: pointer; padding: 8px 2px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 65px; text-align: center; font-size: 0.75rem; transition: 0.2s; position: relative; }
        .behavior-counter { position: absolute; top: -5px; right: -5px; background: #2c3e50; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
        
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 25px; border-radius: 15px; text-align: center; border: 1px solid #eee; box-shadow: 0 4px 6px rgba(0,0,0,0.03); }
        .kpi-card .value { font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-top: 10px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 20px; border-radius: 15px; border: 1px solid #eee; min-height: 400px; }
        .school-ranking-list { list-style: none; padding: 0; }
        .school-rank-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; }
        .attendance-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .attendance-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(24px); }
        .content-section { display: none; }
        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 20px; height: 250px; margin-bottom: 40px; }
        .podium-place { text-align: center; width: 120px; position: relative; }
        .podium-bar { width: 100%; border-radius: 10px 10px 0 0; color: white; font-weight: bold; padding-top: 10px; font-size: 1.5rem; }
        .rank-1 .podium-bar { height: 180px; background: linear-gradient(to bottom, #f1c40f, #f39c12); }
        .rank-2 .podium-bar { height: 130px; background: linear-gradient(to bottom, #bdc3c7, #95a5a6); }
        .rank-3 .podium-bar { height: 90px; background: linear-gradient(to bottom, #e67e22, #d35400); }
        .crown { font-size: 3rem; position: absolute; top: -60px; left: 50%; transform: translateX(-50%); animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }
        .rank-row-1 { background-color: #fffde7 !important; border: 2px solid #fbc02d; font-size: 1.1rem; font-weight: bold; }
        .rank-row-2 { background-color: #f5f5f5 !important; border: 2px solid #95a5a6; font-size: 1.05rem; font-weight: bold; }
        .rank-row-3 { background-color: #fff3e0 !important; border: 2px solid #e67e22; font-size: 1.05rem; font-weight: bold; }
        .medal-icon { font-size: 1.8rem; display: inline-block; }
        .profile-charts-row { display: flex; gap: 20px; margin-bottom: 20px; height: 250px; }
        .profile-chart-box { flex: 1; border: 1px solid #eee; border-radius: 10px; padding: 10px; position: relative; }
        .profile-chart-box h4 { text-align: center; margin: 0 0 10px 0; font-size: 0.95rem; color: #2c3e50; }
        .competence-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px dashed #ccc; }
        .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 6px; border: 1px solid #eee; background: white; }
        .stat-label { font-weight: bold; font-size: 0.85rem; }
        .stat-val-box { display: flex; gap: 10px; align-items: center; }
        .stat-score { font-weight: 900; font-size: 1.1rem; color: var(--primary); }
        .stat-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 12px; color: white; font-weight: bold; min-width: 70px; text-align: center; }
        .badge-none { background: #95a5a6; }
        .badge-encours { background: #f39c12; }
        .badge-acquis { background: #27ae60; }
        .badge-expert { background: #8e44ad; }
        .stat-item.behavior-positive { border: 1px solid #27ae60; background-color: #eafaf1; }
        .stat-item.behavior-negative { border: 1px solid #c0392b; background-color: #fdedec; color: #c0392b; }
        .stat-comment { font-size: 0.8rem; font-weight: 600; color: #555; max-width: 140px; text-align: right; line-height: 1.2; }
        .stat-item.behavior-negative .stat-comment { color: #c0392b; }
        .edit-profile-btn { background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; margin-left: 10px; }
    </style>
</head>
<body>

    <!-- 1. LANDING PAGE -->
    <div id="schoolSelectionPage">
        <div class="landing-header">
            <h1>üíé Espace Professeur Said</h1>
            <p>S√©lectionnez votre √©tablissement pour acc√©der √† la gestion de classe</p>
        </div>
        <div class="schools-grid" id="schoolsGrid"></div>
    </div>

    <!-- 2. MAIN APP -->
    <div id="mainApp" class="main-container">
        <!-- Header -->
        <div class="header">
            <div>
                <button class="back-home-btn" onclick="goBackHome()">‚¨Ö Retour aux √©coles</button>
                <h1 style="margin-top:10px;">Gestion: <span id="currentSchoolDisplay" style="color:var(--accent)">-</span></h1>
                <p style="color:#7f8c8d;">Version Ordinateur v54</p>
            </div>
            
            <div class="add-student-area">
                <input type="hidden" id="editIndex" value="-1">
                <div class="input-group">
                    <label class="input-label">Nom</label>
                    <input type="text" id="studentName" class="input-student" placeholder="Nom...">
                </div>
                <div class="input-group" style="flex:0.6">
                    <label class="input-label">Sexe</label>
                    <select id="studentGender" class="select-gender">
                        <option value="boy">Gar√ßon üë¶</option>
                        <option value="girl">Fille üëß</option>
                    </select>
                </div>
                <input type="hidden" id="studentSchool"> 
                <div class="input-group">
                    <label class="input-label">Naissance</label>
                    <input type="date" id="studentBirth" class="input-date">
                </div>
                <div style="display:flex; gap:5px;">
                    <button id="addBtn" class="btn-add" onclick="handleStudentSubmit()">Ajouter</button>
                    <button id="cancelEditBtn" class="btn-add" onclick="cancelEdit()" style="display: none; background: #95a5a6;">Annuler</button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD MAP -->
        <div id="schoolMapContainer" class="map-container" style="display:none;">
            <iframe id="schoolMapFrame" class="map-frame" src="" allowfullscreen="" loading="lazy"></iframe>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard', this)">üè† Accueil</button>
            <button class="tab-btn" onclick="switchTab('ranking', this)">üèÜ Classement</button>
            <button class="tab-btn" onclick="switchTab('analytics', this)">üìä Statistiques</button>
            <button class="tab-btn" onclick="switchTab('homeworkPage', this)">üìù Devoirs</button>
            <button class="tab-btn" onclick="switchTab('profile', this)">üìÑ Profil & PDF</button>
            <button class="tab-btn" onclick="switchTab('records', this)">üìÖ Historique</button>
        </div>

        <!-- Controls -->
        <div class="control-row">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-weight:bold; color:var(--primary);">Classe active :</span>
                <span id="activeFilterLabel" style="font-weight:bold; color:var(--accent); font-size:1.1rem; display:none;">-</span>
                <select id="parcSubGroupSelector" class="subgroup-select" style="display:none;" onchange="updateParcSubGroup()">
                    <option value="Lundi parc artigues">üîµ Groupe Lundi</option>
                    <option value="Mardi parc artigues">üü£ Groupe Mardi</option>
                    <option value="Mercredi parc artigues">üü† Groupe Mercredi</option>
                </select>
            </div>
            <div class="control-buttons">
                <button class="btn-action btn-save" onclick="saveDay()">üíæ Sauvegarder la journ√©e</button>
                <button class="btn-action btn-reset" onclick="resetAll()">üîÑ R√©initialiser</button>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="content-section" style="display:block;">
            <div id="podiumDisplay" class="podium-container" style="display:none;"></div>
            <div class="student-grid" id="studentsContainer"></div>
            <div id="emptyState" style="text-align: center; color: #999; display: none; padding: 40px;">
                <h3>La liste est vide. Ajoutez des √©l√®ves ci-dessus. üéí</h3>
            </div>
        </div>

        <!-- RANKING -->
        <div id="ranking" class="content-section">
            <h2 style="text-align: center; color: var(--primary);">üèÜ Tableau d'Honneur</h2>
            <table class="daily-report-table" style="margin-top:20px; border-collapse: separate; border-spacing: 0 5px;">
                <thead><tr><th>Rang</th><th>Nom</th><th>√âcole</th><th>Total des Points</th></tr></thead>
                <tbody id="rankingTableBody"></tbody>
            </table>
        </div>

        <!-- STATS -->
        <div id="analytics" class="content-section">
            <h2 id="statsTitle" style="text-align:center; color:var(--primary); margin-bottom:20px;">Vue Globale</h2>
            <div class="kpi-row">
                <div class="kpi-card"><h4>Total Points</h4><div id="statTotalPoints" class="value">0</div></div>
                <div class="kpi-card"><h4>Taux de Pr√©sence</h4><div id="statAttendance" class="value" style="color:var(--success)">0%</div></div>
                <div class="kpi-card"><h4>Top √âcole</h4><div id="statTopSchool" class="value" style="font-size:1.8rem">-</div></div>
            </div>
            <div class="chart-container" style="margin-bottom:30px; border-left: 5px solid var(--accent);">
                <h3>üìÜ Analyse de la Pr√©sence</h3>
                <div style="display:flex; justify-content:space-around; align-items:center;">
                    <div style="width:40%; height:250px;"><canvas id="attendancePieChart"></canvas></div>
                    <div style="width:40%;">
                         <h4 style="margin-bottom:10px;">D√©tails (Total jours archiv√©s)</h4>
                         <ul id="attendanceDetailList" style="list-style:none; padding:0; font-size:1.1rem;"></ul>
                    </div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="chart-container"><h3>üèÜ Classement des √âcoles</h3><ul id="schoolRankingList" class="school-ranking-list"></ul></div>
                <div class="chart-container"><h3>üöª R√©partition</h3><div style="height:300px"><canvas id="genderPieChart"></canvas></div></div>
            </div>
            <div class="stats-grid">
                <div class="chart-container"><h3>üìà √âvolution (Points)</h3><div style="height:350px"><canvas id="lineChart"></canvas></div></div>
                <div class="chart-container"><h3>üìä Comp√©tences</h3><div style="height:350px"><canvas id="barChart"></canvas></div></div>
            </div>
             <div class="chart-container" style="margin-top: 30px;">
                <h3>üìã Liste D√©taill√©e des √âl√®ves (Filtr√©e)</h3>
                <table class="daily-report-table">
                    <thead><tr><th>Nom</th><th>Sexe</th><th>√âcole</th><th>Total Points</th><th>Absences</th></tr></thead>
                    <tbody id="statsStudentTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- HOMEWORK PAGE (NEW v54) -->
        <div id="homeworkPage" class="content-section">
            <h2 style="text-align:center; color:var(--primary);">Cahier de Liaison Num√©rique / Devoirs üìö</h2>
            <div style="max-width:900px; margin:0 auto;">
                <div class="homework-notebook">
                    <textarea id="homeworkTextarea" placeholder="√âcrivez les devoirs ici... (Ils s'afficheront automatiquement sur les rapports PDF)" oninput="saveHomework()"></textarea>
                </div>
                <p class="homework-info">Le texte est sauvegard√© automatiquement. Rendez-vous dans l'onglet <strong>Profil & PDF</strong> pour voir le r√©sultat.</p>
            </div>
        </div>

        <!-- PROFILE -->
        <div id="profile" class="content-section">
            <div class="profile-layout">
                <!-- LEFT SIDEBAR: Controls Only -->
                <div class="profile-sidebar">
                    <h3 style="color:var(--primary); margin:0;">üõ†Ô∏è Contr√¥les</h3>
                    
                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">1. Choisir l'√©l√®ve</label>
                        <select id="profileStudentSelector" onchange="loadStudentProfile()" class="school-filter-select"></select>
                    </div>

                    <div style="background:#eafaf1; border:1px solid #27ae60; padding:15px; border-radius:10px;">
                        <label style="font-weight:bold; color:#27ae60;">2. Devoirs</label>
                        <p style="font-size:0.9rem; margin:5px 0;">Les devoirs sont g√©r√©s dans l'onglet <strong>üìù Devoirs</strong>.</p>
                        <button class="btn-action" style="background:var(--accent); font-size:0.9rem; padding:5px 10px;" onclick="switchTab('homeworkPage', document.querySelectorAll('.tab-btn')[3])">Modifier les devoirs</button>
                    </div>

                    <div style="text-align:center; display:flex; flex-direction:column; gap:10px;">
                        <label style="font-weight:bold;">3. Actions</label>
                        <button id="btnDownloadPDF" class="btn-action" style="background:#e74c3c; width:100%; justify-content:center;" onclick="downloadPDF()">üìÑ T√©l√©charger PDF</button>
                        <button class="btn-action" style="background:#25D366; width:100%; justify-content:center;" onclick="shareViaWhatsapp()">üì± Partager WhatsApp</button>
                    </div>
                </div>

                <!-- RIGHT SIDE: Preview -->
                <div class="profile-preview">
                    <div id="reportCard">
                        <div class="report-header">
                            <div>
                                <h2 id="pSchool">√âcole</h2>
                                <div id="pSchoolInfo" style="font-size:0.85rem; color:#555; max-width:300px; margin-top:5px;"></div>
                            </div>
                            <div style="text-align:center;">
                                <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                                     <h1 id="pName" style="font-size:2.5rem; margin:0;">Nom</h1>
                                     <button class="edit-profile-btn" onclick="editProfileFromView()">‚úèÔ∏è Modifier</button>
                                </div>
                                <p style="font-weight:bold;">Dossier de Suivi √âducatif</p>
                            </div>
                            <div style="text-align:right;">
                                <p id="pDate">--/--/----</p>
                                <div id="qrcode" style="margin-top:10px;"></div>
                            </div>
                        </div>

                        <div style="display:flex; justify-content:space-around; background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:30px;">
                            <div style="text-align:center">
                                <div>Total Cumul√©</div>
                                <span id="pTotal" style="color:var(--accent); font-size:2rem; font-weight:900;">0</span>
                            </div>
                            <div style="text-align:center">
                                <div>Absences</div>
                                <span id="pAbsences" style="color:var(--danger); font-size:2rem; font-weight:900;">0</span>
                            </div>
                        </div>
                        
                        <div class="report-homework-box" id="reportHomeworkBox" style="display:none;">
                            <h4>üìù Devoirs / Cahier de Liaison</h4>
                            <div id="reportHomeworkText" class="report-homework-text"></div>
                        </div>
                        <div style="height:20px;"></div>

                        <h3>Analyses Graphiques</h3>
                        <div class="profile-charts-row">
                            <div class="profile-chart-box">
                                <h4>üìä Points du Jour (ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑŸäŸàŸÖŸäÿ©)</h4>
                                <canvas id="profileBalanceChart"></canvas>
                            </div>
                            <div class="profile-chart-box">
                                <h4>üï∏Ô∏è R√©partition des Comp√©tences</h4>
                                <canvas id="profileSkillDistributionChart"></canvas>
                            </div>
                        </div>

                        <h3>D√©tail des Comp√©tences & Commentaires</h3>
                        <div class="competence-stats-grid" id="competenceStatsGrid"></div>

                        <h3>Progression Temporelle</h3>
                        <div style="width:100%; height:250px; margin-bottom:30px;">
                            <canvas id="profileLineChart"></canvas>
                        </div>

                        <h3>Suivi Quotidien</h3>
                        <table class="daily-report-table">
                            <thead><tr><th>Date</th><th>Pr√©sence</th><th>Comportement</th><th>Travail</th><th>Total</th><th>Visa</th></tr></thead>
                            <tbody id="dailyReportBody"></tbody>
                        </table>
                        
                        <div style="display:flex; justify-content:space-between; margin-top:80px; padding-top:20px; border-top:1px dashed #ccc;">
                            <div>Signature Professeur</div>
                            <div>Signature Parents</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RECORDS -->
        <div id="records" class="content-section">
            <h2 style="text-align:center;">Historique & Absences</h2>
            <div style="display:flex; gap:30px;">
                <div style="flex:1">
                    <h3>Toute la classe</h3>
                    <table class="daily-report-table">
                        <thead><tr><th>Nom</th><th>√âcole</th><th>Total</th></tr></thead>
                        <tbody id="recordsTableBody"></tbody>
                    </table>
                </div>
                <div style="flex:1">
                    <h3>Absences</h3>
                    <table class="daily-report-table">
                        <thead><tr><th>Nom</th><th>Jours d'absence</th></tr></thead>
                        <tbody id="absenceTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- SCHOOL CONFIGURATION DATA ---
        const schoolConfigs = {
            "Parc Artigues": {
                name: "Ecole primaire du parc artigues",
                address: "1 All. du Parc, 33370 Artigues-pr√®s-Bordeaux",
                hours: "Lun/Mar: 17h-18h30 | Mer: 15h-16h30",
                prof: "Prof. SAID ARABE",
                color: "#e74c3c",
                id: "Parc Artigues",
                map: "https://maps.google.com/maps?q=1+All.+du+Parc,+33370+Artigues-pr√®s-Bordeaux&t=&z=15&ie=UTF8&iwloc=&output=embed",
                subgroups: [
                    { name: "Groupe Lundi", val: "Lundi parc artigues", bg: "#2980b9" },
                    { name: "Groupe Mardi", val: "Mardi parc artigues", bg: "#8e44ad" },
                    { name: "Groupe Mercredi", val: "Mercredi parc artigues", bg: "#d35400" }
                ]
            },
            "Henri Bardon": {
                name: "ECOLE PRIMAIRE HENRI BARDON",
                address: "11 PLACE DU CHAMP DE FOIRE, 33350 Castillon",
                hours: "Mercredi: 10h-11h30",
                prof: "Prof. SAID ARABE",
                color: "#27ae60",
                id: "Henri Bardon",
                map: "https://maps.google.com/maps?q=11+PLACE+DU+CHAMP+DE+FOIRE,+33350+Castillon-la-Bataille&t=&z=15&ie=UTF8&iwloc=&output=embed"
            },
            "A.Lacoume": {
                name: "Ecole √©l√©mentaire A.Lacoume",
                address: "1 PLACE CAMILLE GOURDON, 33670 Cr√©on",
                hours: "Jeudi: 17h-18h30",
                prof: "Prof. SAID ARABE",
                color: "#8e44ad",
                id: "A.Lacoume",
                map: "https://maps.google.com/maps?q=1+PLACE+CAMILLE+GOURDON,+33670+Cr√©on&t=&z=15&ie=UTF8&iwloc=&output=embed"
            },
            "Condorcet": {
                name: "Ecole √©l√©mentaire Condorcet",
                address: "1 RUE VALVERT, 33310 Lormont",
                hours: "Vendredi: 16h30-18h",
                prof: "Prof. SAID ARABE",
                color: "#f39c12",
                id: "Condorcet",
                map: "https://maps.google.com/maps?q=1+RUE+VALVERT,+33310+Lormont&t=&z=15&ie=UTF8&iwloc=&output=embed"
            },
            "De La Jalle": {
                name: "Ecole √©l√©mentaire De La Jalle",
                address: "5 avenue du Stade, 33480 Castelnau-de-M√©doc",
                hours: "Samedi: 9h-10h30",
                prof: "Prof. SAID ARABE",
                color: "#2980b9",
                id: "De La Jalle",
                map: "https://maps.google.com/maps?q=5+avenue+du+Stade,+33480+Castelnau-de-M√©doc&t=&z=15&ie=UTF8&iwloc=&output=embed"
            }
        };

        const academicSkills = [
            { id: 'rituels', name: 'Rituels', icon: '‚òÄÔ∏è' },
            { id: 'interaction', name: 'Interaction', icon: 'üó£Ô∏è' },
            { id: 'ecoute', name: 'Compr√©hension', icon: 'üëÇ' },
            { id: 'lecture', name: 'Lecture', icon: 'üìñ' },
            { id: 'ecriture', name: '√âcriture', icon: '‚úçÔ∏è' },
            { id: 'devoirs', name: 'Devoirs', icon: 'üìù' }
        ];

        const behaviorSkills = [
            { id: 'concentre', name: 'Concentr√©', icon: 'üß†', val: 1, type: 'positive' },
            { id: 'participation', name: 'Particip.', icon: 'üôã‚Äç‚ôÇÔ∏è', val: 1, type: 'positive' },
            { id: 'bavardage', name: 'Bavardage', icon: 'üì¢', val: -1, type: 'negative' },
            { id: 'moquerie', name: 'Moquerie', icon: 'üòè', val: -1, type: 'negative' },
            { id: 'insulte', name: 'Insulte', icon: 'ü§¨', val: -1, type: 'negative' },
            { id: 'violent', name: 'Violence', icon: 'üëä', val: -1, type: 'negative' },
            { id: 'attitude', name: 'Attitude', icon: 'üòí', val: -1, type: 'negative' },
            { id: 'oublie', name: 'Oubli', icon: 'üéí', val: -1, type: 'negative' }
        ];

        const allSkills = [...academicSkills, ...behaviorSkills];
        let students = JSON.parse(localStorage.getItem('profSaidStudents_v26')) || [];
        let currentSchoolFilter = null; 

        // --- INIT ---
        function initData() {
            const newMardiStudents = ["Ben Hamou Hafsa", "Navaro Sana", "Talla Lamine", "Bouarrouj Ahmed", "Macabre Ines", "Khiar Djoumena", "Gantch Nael", "Sahbani Eden", "chaari Fares", "Pince Hana", "Mourchid Sarah", "Nesta Djibril"];
            const lundiStudents = ["Belarbi Nayla", "Cruveiller Yanis", "Rizgui Ryan", "Rizgui Hidaya", "Nesta Selma", "Zitoun Souheil", "Bouchouicha Nohe", "Alami Jihane", "Tahiri Solaymane", "Mezrig Ahmed", "Alami Salim", "Zerrouki Wassim"];

            lundiStudents.forEach(n => {
                if(!students.find(s=>s.name===n)) createStudent(n, "Lundi parc artigues", n.includes("Nayla")||n.includes("Hidaya")||n.includes("Selma")||n.includes("Jihane")?'girl':'boy');
            });
            newMardiStudents.forEach(n => {
                 if(!students.find(s=>s.name===n)) {
                    let g = (n.includes("Hafsa") || n.includes("Sana") || n.includes("Ines") || n.includes("Djoumena") || n.includes("Hana") || n.includes("Sarah")) ? 'girl' : 'boy';
                    createStudent(n, "Mardi parc artigues", g);
                }
            });
            renderLandingPage();
        }

        function createStudent(name, school, gender) {
            let newStudent = {
                id: Date.now() + Math.random(),
                name: name, school: school, gender: gender, birthdate: "",
                scores: {}, cumulativeScores: {}, dailyTotal: 0, historicalTotal: 0,
                history: [0], historyLog: [], absences: 0, isAbsent: false
            };
            allSkills.forEach(k => { newStudent.scores[k.id] = 0; newStudent.cumulativeScores[k.id] = 0; });
            students.push(newStudent);
            saveData();
        }

        function saveData() { localStorage.setItem('profSaidStudents_v26', JSON.stringify(students)); }
        function getGrandTotal(s) { return (s.historicalTotal || 0) + (s.dailyTotal || 0); }

        // --- LANDING PAGE ---
        function renderLandingPage() {
            const grid = document.getElementById('schoolsGrid');
            grid.innerHTML = '';
            
            Object.values(schoolConfigs).forEach(conf => {
                let extraContent = '';
                if(conf.id === "Parc Artigues" && conf.subgroups) {
                    extraContent += `<div class="subgroup-buttons">`;
                    conf.subgroups.forEach(sub => {
                        extraContent += `<button class="btn-subgroup" style="background:${sub.bg}" onclick="event.stopPropagation(); selectSchool('${conf.id}', '${sub.val}')">${sub.name}</button>`;
                    });
                    extraContent += `</div>`;
                } else {
                    extraContent = `<button class="btn-enter-school" onclick="event.stopPropagation(); selectSchool('${conf.id}')">Acc√©der √† la classe ‚û°</button>`;
                }

                grid.innerHTML += `
                    <div class="school-card" onclick="selectSchool('${conf.id}')">
                        <div class="school-card-header" style="background:${conf.color}">
                            <h3>${conf.name}</h3>
                            <div class="school-badge">${conf.prof}</div>
                        </div>
                        <div class="school-card-body">
                            <div class="school-info-item">üìç ${conf.address}</div>
                            <div class="school-info-item">üïí ${conf.hours}</div>
                            ${extraContent}
                        </div>
                    </div>
                `;
            });
        }

        function selectSchool(schoolId, subGroup = null) {
            const conf = schoolConfigs[schoolId];
            document.getElementById('schoolSelectionPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentSchoolDisplay').innerText = conf.name;
            
            const mapContainer = document.getElementById('schoolMapContainer');
            if(conf.map) {
                mapContainer.style.display = 'block';
                document.getElementById('schoolMapFrame').src = conf.map;
            } else mapContainer.style.display = 'none';

            const subGroupSel = document.getElementById('parcSubGroupSelector');
            const stdLabel = document.getElementById('activeFilterLabel');

            if(schoolId === "Parc Artigues") {
                subGroupSel.style.display = 'inline-block';
                stdLabel.style.display = 'none';
                let target = subGroup || "Lundi parc artigues";
                subGroupSel.value = target;
                currentSchoolFilter = target; 
                document.getElementById('studentSchool').value = target;
            } else {
                subGroupSel.style.display = 'none';
                stdLabel.style.display = 'inline-block';
                stdLabel.innerText = conf.name;
                currentSchoolFilter = schoolId;
                document.getElementById('studentSchool').value = schoolId;
            }
            
            loadHomework(); 
            renderDashboard();
        }
        
        function updateParcSubGroup() {
            const val = document.getElementById('parcSubGroupSelector').value;
            currentSchoolFilter = val;
            document.getElementById('studentSchool').value = val;
            loadHomework();
            renderDashboard();
        }

        function goBackHome() {
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('schoolSelectionPage').style.display = 'block';
        }

        // --- HOMEWORK ---
        function saveHomework() {
            if(!currentSchoolFilter) return;
            const text = document.getElementById('homeworkTextarea').value;
            localStorage.setItem(`homework_${currentSchoolFilter}`, text);
        }

        function loadHomework() {
            if(!currentSchoolFilter) return;
            const text = localStorage.getItem(`homework_${currentSchoolFilter}`) || "";
            // Ensure element exists in Homework Page
            const el = document.getElementById('homeworkTextarea');
            if(el) el.value = text;
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            const container = document.getElementById('studentsContainer');
            const emptyState = document.getElementById('emptyState');
            const podium = document.getElementById('podiumDisplay');
            container.innerHTML = '';

            let filtered = students.filter(s => {
                if(s.school === currentSchoolFilter) return true;
                if(currentSchoolFilter === "Henri Bardon" && (s.school === "Henri Bardon" || s.school.includes("bardone"))) return true;
                if(currentSchoolFilter === "A.Lacoume" && (s.school === "A.Lacoume" || s.school.includes("Albanie"))) return true;
                return false;
            });

            if (filtered.length === 0) { emptyState.style.display = 'block'; podium.style.display = 'none'; }
            else emptyState.style.display = 'none';

            let sorted = [...filtered].sort((a, b) => getGrandTotal(b) - getGrandTotal(a));
            if(sorted.length >= 3 && getGrandTotal(sorted[0]) > 0) {
                podium.style.display = 'flex';
                let html = '';
                [1,0,2].forEach(i => {
                    let s = sorted[i];
                    if(s) html += `<div class="podium-place rank-${i+1}"><div class="crown" style="display:${i==0?'block':'none'}">üëë</div><div class="podium-bar">${getGrandTotal(s)}</div><div style="font-weight:bold">${s.gender==='girl'?'üëß':'üë¶'} ${s.name}</div></div>`;
                });
                podium.innerHTML = html;
            } else podium.style.display = 'none';

            filtered.forEach((student) => {
                const index = students.findIndex(s => s.id === student.id);
                const card = document.createElement('div');
                let classes = `student-card ${student.gender}`;
                if (student.isAbsent) classes += ' absent';
                card.className = classes;

                let academicHTML = '';
                academicSkills.forEach(skill => {
                    academicHTML += `<div class="skill-row"><span class="skill-name">${skill.icon} ${skill.name}</span><div style="display:flex; gap:5px; align-items:center;"><button class="btn-control btn-minus" onclick="updateScore(${index}, '${skill.id}', -1)">-</button><span class="skill-val">${student.scores[skill.id]}</span><button class="btn-control btn-plus" onclick="updateScore(${index}, '${skill.id}', 1)">+</button></div></div>`;
                });

                let behaviorHTML = '<div class="behavior-grid">';
                behaviorSkills.forEach(skill => {
                    const count = student.scores[skill.id];
                    let bg = count !== 0 ? (skill.type==='positive'?'#e8f8f5':'#fdedec') : 'white';
                    let border = count !== 0 ? (skill.type==='positive'?'2px solid #27ae60':'2px solid #c0392b') : '1px solid #eee';
                    behaviorHTML += `<div class="behavior-btn" style="background:${bg}; border:${border}" onclick="updateScore(${index}, '${skill.id}', ${skill.val})">${count!==0 ? `<div class="behavior-counter">${count}</div>` : ''}<div style="font-size:1.5rem;">${skill.icon}</div><div>${skill.name}</div></div>`;
                });
                behaviorHTML += '</div>';

                card.innerHTML = `<div style="position:absolute; top:10px; right:10px; display:flex; gap:5px;"><button style="border:none;background:none;cursor:pointer;font-size:1.2rem;" onclick="editStudent(${index})">‚úèÔ∏è</button><button style="border:none;background:none;cursor:pointer;font-size:1.2rem;" onclick="deleteStudent(${index})">üóëÔ∏è</button></div><div class="student-header"><div><div class="student-name">${student.gender==='girl'?'üëß':'üë¶'} ${student.name}</div><small style="color:#777">üè´ ${student.school}</small></div><div style="text-align:center; margin-right:40px;"><div class="total-badge">${getGrandTotal(student)}</div><label class="attendance-switch" style="margin-top:5px;"><input type="checkbox" ${!student.isAbsent?'checked':''} onchange="toggleAbsence(${index}, this.checked)"><span class="slider"></span></label></div></div>${student.isAbsent ? '<div style="text-align:center; padding:50px; color:var(--danger); font-weight:bold;">√âl√®ve Absent (-1 Point)</div>' : academicHTML + behaviorHTML}`;
                container.appendChild(card);
            });
            updateProfileDropdown(filtered);
        }

        function updateScore(index, skillId, change) {
            if(students[index].isAbsent) return;
            students[index].scores[skillId] += change;
            students[index].dailyTotal += change;
            saveData(); renderDashboard();
        }

        function toggleAbsence(index, isChecked) {
            const s = students[index];
            s.isAbsent = !isChecked;
            if(s.isAbsent) { s.dailyTotal -= 1; s.absences += 1; }
            else { s.dailyTotal += 1; s.absences = Math.max(0, s.absences - 1); }
            saveData(); renderDashboard();
        }
        
        // --- STUDENT MANAGEMENT ---
        function handleStudentSubmit() {
            const name = document.getElementById('studentName').value;
            const gender = document.getElementById('studentGender').value;
            const birth = document.getElementById('studentBirth').value;
            const idx = document.getElementById('editIndex').value;
            const school = currentSchoolFilter; 

            if(!name) return;
            if(idx === "-1") {
                createStudent(name, school, gender);
                students[students.length-1].birthdate = birth;
            } else {
                students[idx].name = name;
                students[idx].gender = gender;
                students[idx].birthdate = birth;
                cancelEdit();
            }
            saveData(); 
            document.getElementById('studentName').value = '';
            renderDashboard();
            alert('Enregistr√© !');
        }

        function editStudent(index) {
            const s = students[index];
            document.getElementById('studentName').value = s.name;
            document.getElementById('studentGender').value = s.gender;
            document.getElementById('studentBirth').value = s.birthdate || '';
            document.getElementById('editIndex').value = index;
            document.getElementById('cancelEditBtn').style.display = 'block';
            switchTab('dashboard', document.querySelector('.tab-btn:first-child'));
            window.scrollTo({top:0, behavior:'smooth'});
        }

        function cancelEdit() {
            document.getElementById('studentName').value = '';
            document.getElementById('editIndex').value = "-1";
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function deleteStudent(index) { if(confirm('Supprimer ?')) { students.splice(index, 1); saveData(); renderDashboard(); } }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.content-section').forEach(d => d.style.display='none');
            document.getElementById(tabId).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(tabId === 'analytics') setTimeout(updateCharts, 100);
            if(tabId === 'profile') loadStudentProfile(); 
            if(tabId === 'ranking') renderRanking();
            if(tabId === 'records') renderRecords();
            if(tabId === 'homeworkPage') loadHomework();
        }

        function updateProfileDropdown(filteredList) {
            const sel = document.getElementById('profileStudentSelector');
            sel.innerHTML = '<option value="" disabled selected>-- S√©lectionner un √©l√®ve --</option>';
            filteredList.forEach(s => {
                const globalIndex = students.findIndex(st => st.id === s.id);
                sel.innerHTML += `<option value="${globalIndex}">${s.name}</option>`;
            });
        }

        function editProfileFromView() { const idx = document.getElementById('profileStudentSelector').value; if(idx) editStudent(idx); }

        let mainCharts = {}; 
        let profileCharts = {}; 

        function loadStudentProfile() {
            const idx = document.getElementById('profileStudentSelector').value;
            // Always load homework for display
            const hwText = localStorage.getItem(`homework_${currentSchoolFilter}`) || "";
            const hwBox = document.getElementById('reportHomeworkBox');
            if(hwText.trim()) {
                hwBox.style.display = "block";
                document.getElementById('reportHomeworkText').innerText = hwText;
            } else {
                hwBox.style.display = "none";
            }
            
            if(idx === "") return;
            const s = students[idx];
            
            document.getElementById('pName').innerText = (s.gender==='girl'?'üëß':'üë¶') + ' ' + s.name;
            document.getElementById('pSchool').innerText = 'üè´ ' + s.school;
            document.getElementById('pTotal').innerText = getGrandTotal(s);
            document.getElementById('pDate').innerText = new Date().toLocaleDateString('fr-FR');
            
            const schoolInfo = Object.values(schoolConfigs).find(c => s.school.includes(c.name) || s.school.includes(c.id.split(' ')[0]) || (c.id === "Parc Artigues" && s.school.includes("artigues")));
            if(schoolInfo) document.getElementById('pSchoolInfo').innerHTML = `${schoolInfo.address}<br>${schoolInfo.hours}`;

            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: `${s.name} | ${getGrandTotal(s)} pts | ${s.school}`, width: 80, height: 80 });

            const tbody = document.getElementById('dailyReportBody'); tbody.innerHTML = '';
            if(s.historyLog.length) {
                [...s.historyLog].reverse().forEach(log => {
                    tbody.innerHTML += `<tr><td>${log.date}</td><td>${log.isAbsent?'Abs':'Pr√©s'}</td><td>${log.behavior||0}</td><td>${log.academic||0}</td><td><strong>${log.score}</strong></td><td></td></tr>`;
                });
            } else tbody.innerHTML = '<tr><td colspan="6">Aucun historique</td></tr>';

            if(profileCharts.line) profileCharts.line.destroy();
            if(profileCharts.bar) profileCharts.bar.destroy();
            if(profileCharts.radar) profileCharts.radar.destroy();

            profileCharts.line = new Chart(document.getElementById('profileLineChart'), {
                type: 'line', data: { labels: s.historyLog.map(h => h.date.slice(5)), datasets: [{ label: 'Travail', data: s.historyLog.map(h => h.academic), borderColor: '#3498db', tension:0.3 }, { label: 'Comportement', data: s.historyLog.map(h => h.behavior), borderColor: '#e74c3c', tension:0.3 }] }, options: { responsive: true, maintainAspectRatio: false }
            });

            profileCharts.bar = new Chart(document.getElementById('profileBalanceChart'), {
                type: 'bar', data: { labels: academicSkills.map(k=>k.name), datasets: [{ label: 'Aujourd\'hui', data: academicSkills.map(k=>s.scores[k.id]), backgroundColor: '#3498db', borderRadius:4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: {beginAtZero:true, ticks:{stepSize:1}} }, plugins:{legend:{display:false}} }
            });

            let skillValues = academicSkills.map(k => (s.cumulativeScores?s.cumulativeScores[k.id]:0) + s.scores[k.id]);
            profileCharts.radar = new Chart(document.getElementById('profileSkillDistributionChart'), {
                type: 'radar', data: { labels: academicSkills.map(k=>k.name), datasets: [{ label: 'Global', data: skillValues, backgroundColor: 'rgba(52,152,219,0.2)', borderColor: '#3498db' }] }, options: { responsive: true, maintainAspectRatio: false, scales:{r:{beginAtZero:true, ticks:{display:false}}} }
            });

            const statsGrid = document.getElementById('competenceStatsGrid'); statsGrid.innerHTML = '';
            academicSkills.forEach(skill => {
                let score = (s.cumulativeScores?s.cumulativeScores[skill.id]:0) + s.scores[skill.id];
                let badge = score<3?'En cours':(score<5?'Acquis':'Expert');
                let bClass = score<3?'badge-encours':(score<5?'badge-acquis':'badge-expert');
                if(score===0) { badge='Non √©valu√©'; bClass='badge-none'; }
                statsGrid.innerHTML += `<div class="stat-item"><span class="stat-label">${skill.icon} ${skill.name}</span><div class="stat-val-box"><span class="stat-score">${score}</span><span class="stat-badge ${bClass}">${badge}</span></div></div>`;
            });
            behaviorSkills.forEach(skill => {
                let score = (s.cumulativeScores?s.cumulativeScores[skill.id]:0) + s.scores[skill.id];
                if(score !== 0) {
                    let count = Math.abs(score);
                    let isNeg = skill.type === 'negative' || score < 0; 
                    let text = isNeg ? `‚ö†Ô∏è ${count} fois` : `üåü ${count} fois`;
                    let sClass = isNeg ? 'behavior-negative' : 'behavior-positive';
                    statsGrid.innerHTML += `<div class="stat-item ${sClass}"><span class="stat-label">${skill.icon} ${skill.name}</span><div class="stat-comment">${text}</div></div>`;
                }
            });
        }

        function downloadPDF() {
            const btn = document.getElementById('btnDownloadPDF'); const original = btn.innerText;
            btn.innerText = "‚è≥ G√©n√©ration..."; window.scrollTo(0,0);
            const element = document.getElementById('reportCard');
            html2pdf().set({ margin:0, filename:`Rapport_${document.getElementById('pName').innerText}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2, useCORS:true, scrollY:0}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }).from(element).save().then(()=>{ btn.innerText=original; });
        }

        function shareViaWhatsapp() {
            const name = document.getElementById('pName').innerText; const total = document.getElementById('pTotal').innerText;
            window.open(`https://wa.me/?text=Rapport ${name}: ${total} points.`, '_blank');
        }

        function updateCharts() {
            let filtered = students.filter(s => {
               if(s.school === currentSchoolFilter) return true;
               if(currentSchoolFilter === "Henri Bardon" && (s.school === "Henri Bardon" || s.school.includes("bardone"))) return true;
               if(currentSchoolFilter === "A.Lacoume" && (s.school === "A.Lacoume" || s.school.includes("Albanie"))) return true;
               return false;
            });
            
            let maxDays = filtered.reduce((max, s) => Math.max(max, (s.historyLog||[]).length), 0);
            let totalAbsences = filtered.reduce((acc, s) => acc + s.absences, 0);
            let possibleAttendance = maxDays * filtered.length;
            let presentDays = possibleAttendance - totalAbsences;
            let rate = possibleAttendance > 0 ? ((presentDays/possibleAttendance)*100).toFixed(1) : 100;
            
            document.getElementById('statAttendance').innerText = rate + "%";
            document.getElementById('attendanceDetailList').innerHTML = `<li>‚úÖ Pr√©sents: <strong>${presentDays}</strong></li><li style="color:var(--danger)">‚ùå Absents: <strong>${totalAbsences}</strong></li>`;

            if(mainCharts.att) mainCharts.att.destroy();
            mainCharts.att = new Chart(document.getElementById('attendancePieChart'), { type: 'pie', data: { labels: ['Pr√©sents', 'Absents'], datasets:[{ data:[presentDays, totalAbsences], backgroundColor:['#2ecc71','#e74c3c'] }] }, options:{responsive:true,maintainAspectRatio:false} });
            
            if(mainCharts.pie) mainCharts.pie.destroy();
            let boys = filtered.filter(s=>s.gender==='boy').length;
            let girls = filtered.filter(s=>s.gender==='girl').length;
            mainCharts.pie = new Chart(document.getElementById('genderPieChart'), { type: 'doughnut', data: { labels:['G','F'], datasets:[{data:[boys,girls], backgroundColor:['#3498db','#fd79a8']}] }, options:{responsive:true,maintainAspectRatio:false} });

            document.getElementById('schoolRankingList').innerHTML = ''; 
            document.getElementById('statTotalPoints').innerText = filtered.reduce((a,b)=>a+getGrandTotal(b),0);
        }
        
        function saveDay() {
            if(!confirm('Sauvegarder la journ√©e ?')) return;
            const today = new Date().toISOString().slice(0, 10);
            
            let targetStudents = students.filter(s => {
               if(s.school === currentSchoolFilter) return true;
               if(currentSchoolFilter === "Henri Bardon" && (s.school === "Henri Bardon" || s.school.includes("bardone"))) return true;
               if(currentSchoolFilter === "A.Lacoume" && (s.school === "A.Lacoume" || s.school.includes("Albanie"))) return true;
               return false;
            });

            targetStudents.forEach(s => {
                let ac = 0; academicSkills.forEach(k=>ac+=s.scores[k.id]);
                let beh = 0; behaviorSkills.forEach(k=>beh+=s.scores[k.id]*k.val);
                if(!s.cumulativeScores) s.cumulativeScores={};
                allSkills.forEach(k => { if(!s.cumulativeScores[k.id]) s.cumulativeScores[k.id]=0; s.cumulativeScores[k.id]+=s.scores[k.id]; });

                let idx = s.historyLog.findIndex(l=>l.date===today);
                if(idx!==-1) {
                    s.historyLog[idx].score += s.dailyTotal; s.historyLog[idx].academic += ac; s.historyLog[idx].behavior += beh;
                    if(s.isAbsent) s.historyLog[idx].isAbsent = true;
                } else {
                    s.historyLog.push({ date:today, score:s.dailyTotal, academic:ac, behavior:beh, isAbsent:s.isAbsent });
                }
                s.historicalTotal += s.dailyTotal; s.dailyTotal = 0; s.isAbsent = false; allSkills.forEach(k=>s.scores[k.id]=0);
            });
            saveData(); renderDashboard(); alert('Sauvegard√© pour cette √©cole !');
        }

        function renderRanking() {
            let filtered = students.filter(s => {
               if(s.school === currentSchoolFilter) return true;
               if(currentSchoolFilter === "Henri Bardon" && (s.school === "Henri Bardon" || s.school.includes("bardone"))) return true;
               if(currentSchoolFilter === "A.Lacoume" && (s.school === "A.Lacoume" || s.school.includes("Albanie"))) return true;
               return false;
            });
            let sorted = [...filtered].sort((a,b) => getGrandTotal(b) - getGrandTotal(a));
            const tb = document.getElementById('rankingTableBody'); tb.innerHTML='';
            sorted.forEach((s,i)=>{
                let c = i===0?'rank-row-1':(i===1?'rank-row-2':(i===2?'rank-row-3':''));
                tb.innerHTML+=`<tr class="${c}"><td>${i+1}</td><td>${s.name}</td><td>${s.school}</td><td>${getGrandTotal(s)}</td></tr>`;
            });
        }
        
        function renderRecords() {
            const tb = document.getElementById('recordsTableBody'); tb.innerHTML='';
            let filtered = students.filter(s => {
               if(s.school === currentSchoolFilter) return true;
               if(currentSchoolFilter === "Henri Bardon" && (s.school === "Henri Bardon" || s.school.includes("bardone"))) return true;
               if(currentSchoolFilter === "A.Lacoume" && (s.school === "A.Lacoume" || s.school.includes("Albanie"))) return true;
               return false;
            });
            filtered.forEach(s=>tb.innerHTML+=`<tr><td>${s.name}</td><td>${s.school}</td><td>${getGrandTotal(s)}</td></tr>`);
        }

        function resetAll() {
            if(!confirm('Vider TOUTES les donn√©es ?')) return;
            students.forEach(s => { s.dailyTotal=0; s.historicalTotal=0; s.historyLog=[]; s.scores={}; s.cumulativeScores={}; s.absences=0; });
            allSkills.forEach(k=>students.forEach(s=>{s.scores[k.id]=0; s.cumulativeScores[k.id]=0}));
            saveData(); renderDashboard();
        }

        initData();
    </script>
</body>
</html>
